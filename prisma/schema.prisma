generator client {
  provider = "prisma-client-js"
}

generator json {
  provider = "prisma-json-types-generator"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id             String        @id @default(cuid())
  supabaseId     String        @unique
  email          String        @unique
  name           String?
  role           UserRole      @default(USER)
  organizationId String?
  isActive       Boolean       @default(true)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  organization   Organization? @relation(fields: [organizationId], references: [id])

  @@map("users")
}

model Organization {
  id               String           @id @default(cuid())
  name             String
  slug             String           @unique
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  description      String?
  agents           Agent[]
  conversations    Conversation[]
  customerMemories CustomerMemory[]
  integrations     Integration[]
  knowledgeEntries KnowledgeEntry[]
  users            User[]

  @@map("organizations")
}

model Integration {
  id                String             @id @default(cuid())
  organizationId    String
  type              String
  name              String
  /// [IntegrationCredentials]
  credentials       Json               @default("{}")
  isActive          Boolean            @default(true)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  description       String?
  agentIntegrations AgentIntegration[]
  organization      Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, type])
  @@map("integrations")
}

model Agent {
  id                String             @id @default(cuid())
  organizationId    String
  name              String
  tools             String[]           @default([])
  model             String             @default("gpt-4o")
  isActive          Boolean            @default(true)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  description       String?
  maxTokens         Int                @default(4000)
  /// [AgentRules]
  rules             Json?              @default("{}")
  systemPrompt      String?
  temperature       Float              @default(0.7)
  agentIntegrations AgentIntegration[]
  organization      Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  conversations     Conversation[]

  @@map("agents")
}

model AgentIntegration {
  id            String      @id @default(cuid())
  agentId       String
  integrationId String
  isEnabled     Boolean     @default(true)
  selectedTools String[]    @default([])
  /// [AgentIntegrationConfig]
  config        Json?       @default("{}")
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  agent         Agent       @relation(fields: [agentId], references: [id], onDelete: Cascade)
  integration   Integration @relation(fields: [integrationId], references: [id], onDelete: Cascade)

  @@unique([agentId, integrationId])
  @@map("agent_integrations")
}

model Conversation {
  id             String       @id @default(cuid())
  organizationId String
  agentId        String?
  customerId     String?
  customerEmail  String?
  customerName   String?
  /// [ConversationMessages]
  messages       Json         @default("[]")
  status         String       @default("open")
  channel        String       @default("web")
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  agent          Agent?       @relation(fields: [agentId], references: [id])
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, status])
  @@map("conversations")
}

model CustomerMemory {
  id             String                 @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  customerId     String                 @map("customer_id")
  organizationId String                 @map("organization_id")
  content        String
  memoryType     String                 @default("context") @map("memory_type")
  embedding      Unsupported("vector")?
  metadata       Json                   @default("{}")
  createdAt      DateTime               @default(now()) @map("created_at") @db.Timestamptz(6)
  organization   Organization           @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([customerId, organizationId])
  @@index([createdAt(sort: Desc)])
  @@map("customer_memories")
}

model KnowledgeEntry {
  id             String                 @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String                 @map("organization_id")
  title          String
  content        String
  category       String?
  tags           String[]               @default([])
  embedding      Unsupported("vector")?
  metadata       Json                   @default("{}")
  isActive       Boolean                @default(true) @map("is_active")
  createdAt      DateTime               @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime               @updatedAt @map("updated_at") @db.Timestamptz(6)
  organization   Organization           @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@map("knowledge_entries")
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  USER
}
